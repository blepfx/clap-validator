name: Test Validate

on:
  push:
  pull_request:
    branches:
      - master

defaults:
  run:
    shell: bash

jobs:
  check:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    name: Check on ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run tests
        run: cargo test --all

      - name: Run clippy
        run: cargo clippy --all -- -D warnings

  validate:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        plugin: [clack-synth]
        include:
          - os: ubuntu-latest
            plugin: clack-synth
            plugin_lib: libclack_synth.so
          - os: windows-latest
            plugin: clack-synth
            plugin_lib: clack_synth.dll
          - os: macos-latest
            plugin: clack-synth
            plugin_lib: libclack_synth.dylib
    runs-on: ${{ matrix.os }}
    name: Validate ${{ matrix.plugin }} on ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build validator
        run: cargo build -p clap-validator

      - name: Build plugin
        run: |
          cargo build -p ${{ matrix.plugin }}

      - name: Run validator
        run: |
          "target/debug/clap-validator" validate "./target/debug/${{ matrix.plugin_lib }}"